<?xml version="1.0" encoding="utf-8"?>

<feed xmlns="http://www.w3.org/2005/Atom" >
  <generator uri="https://jekyllrb.com/" version="3.9.0">Jekyll</generator>
  <link href="https://www.briglamoreaux.com/tag/ops/feed.xml" rel="self" type="application/atom+xml" />
  <link href="https://www.briglamoreaux.com/" rel="alternate" type="text/html" />
  <updated>2022-06-21T17:49:45-07:00</updated>
  <id>https://www.briglamoreaux.com/tag/ops/feed.xml</id>

  
  
  

  
    <title type="html">Brig Lamoreaux | </title>
  

  
    <subtitle>Long term storage for a forgetful mind</subtitle>
  

  

  
    
      
    
  

  
  

  
    <entry>
      <title type="html">Updating and Migrating Confluence</title>
      <link href="https://www.briglamoreaux.com/2018/09/13/updating-and-migrating-confluence.html" rel="alternate" type="text/html" title="Updating and Migrating Confluence" />
      <published>2018-09-13T00:00:00-07:00</published>
      <updated>2018-09-13T00:00:00-07:00</updated>
      <id>https://www.briglamoreaux.com/2018/09/13/updating-and-migrating-confluence</id>
      <content type="html" xml:base="https://www.briglamoreaux.com/2018/09/13/updating-and-migrating-confluence.html">&lt;p&gt;I started hosting my wiki on Azure way back in 2016. The other day I received a message that I was  not using managed disks and I should upgrade. So I pushed the upgrade button and kicked off a two day outage which resulted in me pulling my hair out, migrating, looking at logs, and changing databases.&lt;/p&gt;

&lt;h2 id=&quot;first-architecture&quot;&gt;First Architecture&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;https://www.briglamoreaux.com/assets/images/confluencev1.png&quot; alt=&quot;Confluence v1 Architecture&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The first architecture is really basic. Just two vms. One with confluence installed on it and the other with Postgresql. I configured a separate nsg for each one. Looking back I could have had just one.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;App Server
    &lt;ul&gt;
      &lt;li&gt;Confluence 5.9.6&lt;/li&gt;
      &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;CONFLUENCE_HOME&amp;gt; = /var/atlassian/application-data/confluence/&lt;/code&gt;&lt;/li&gt;
      &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;CONFLUENCE_INSTALLATION&amp;gt; = /opt/atlassian/confluence/&lt;/code&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt; Database
    &lt;ul&gt;
      &lt;li&gt;Ubuntu 14.04 64-bit&lt;/li&gt;
      &lt;li&gt;PostgreSQL 9.3.12&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;trouble-after-reboot&quot;&gt;Trouble after Reboot&lt;/h2&gt;

&lt;p&gt;When I rebooted the machine, after a failed managed disk migration, I wasn’t able to log in. It took me a while &lt;a href=&quot;https://community.atlassian.com/t5/Confluence-questions/Failed-to-Login-after-Reboot-Confluence-5-9-6/qaq-p/889565&quot;&gt;to figure out what happened&lt;/a&gt;. Turns out I had two instances of confluence running on the app server. This made me think I should do a few things:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Make a backup&lt;/li&gt;
  &lt;li&gt;Clean up the installation&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Instead of cleaning up the installation I thought I would try a new architecture&lt;/p&gt;

&lt;h2 id=&quot;new-architecture&quot;&gt;New Architecture&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;https://www.briglamoreaux.com/assets/images/confluencev2.png&quot; alt=&quot;confluencev2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I replaced the IaaS database for the Azure Database Postgresql PaaS solution. I don’t want to mess around with managing a database. One less thing to think about.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;App Server
    &lt;ul&gt;
      &lt;li&gt;Confluence 5.9.6 (Can’t change)&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt; Database
    &lt;ul&gt;
      &lt;li&gt;PostgreSQL 9.5&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Confluence does not support Postgres 9.6, and will throw error messages like the following: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;org.postgresql.util.PSQLException: ERROR: column am.amcanorder does not exist&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;future-work&quot;&gt;Future work&lt;/h2&gt;

&lt;p&gt;Turns out I had to use the export restore option with Confluence. I though I would be able to setup the new environment and just perform a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pg_dump&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pg_restore&lt;/code&gt;. For some reason that didn’t work.&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Restore to Azure DB Postgres &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/postgresql/quickstart-create-server-database-portal&quot;&gt;https://docs.microsoft.com/en-us/azure/postgresql/quickstart-create-server-database-portal&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;How to dump and restore &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/postgresql/howto-migrate-using-dump-and-restore&quot;&gt;https://docs.microsoft.com/en-us/azure/postgresql/howto-migrate-using-dump-and-restore&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Example of Confluence Setup &lt;a href=&quot;http://comtronic.com.au/how-to-install-confluence-on-centos7-with-postgresql/&quot;&gt;http://comtronic.com.au/how-to-install-confluence-on-centos7-with-postgresql/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Remove ubuntu services &lt;a href=&quot;https://help.ubuntu.com/community/UbuntuBootupHowto&quot;&gt;https://help.ubuntu.com/community/UbuntuBootupHowto&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content>

      
      
      
      
      

      <author>
          <name>Brig Lamoreaux</name>
        
        
      </author>

      

      
        <category term="confluence" />
      
        <category term="linux" />
      
        <category term="ops" />
      
        <category term="postgresql" />
      
        <category term="software" />
      

      
        <summary type="html">I started hosting my wiki on Azure way back in 2016. The other day I received a message that I was  not using managed disks and I should upgrade. So I pushed the upgrade button and kicked off a two day outage which resulted in me pulling my hair out, migrating, looking at logs, and changing databases.</summary>
      

      
      
    </entry>
  
</feed>
